# DDD（ドメイン駆動設計）を厚めに理解する

この章では、DDD の主要概念を「定義→目的→このアプリでの具体例」の順に整理します。DDD は“流行の設計”ではなく「複雑なルールを正しく守り続けるための設計」です。ここでは **ジョブの状態遷移** を中心に読み解きます。

## なぜ DDD が必要か（背景）

- **ビジネスルールは複雑で変化する**: 例）「完了後のキャンセルは禁止」など\n- **技術は入れ替わる**: DB やフレームワークは変わっても、ルールは残る\n- DDD は **「ルールを中心に置く」** ことで変更に強い構造を作る

## DDD の出発点: ドメインとは何か

- **ドメイン** = その業務が持つルールや制約（例: ジョブは完了後にキャンセルできない）
- DDD は **“業務ルールをコードに押し込む”** ための設計思想

このアプリのドメインは「ジョブのライフサイクル管理」です。

## エンティティ（Entity）

**定義**: 同一性（identity）で識別され、時間とともに状態が変化するオブジェクト。

- 重要なのは「同じ ID なら同じ存在」
- 値が変わっても同一性が保たれる

**このアプリの例**:
- `Job`（`backend/src/app/domain/models/job.py`）
- `JobId` がアイデンティティ

## 値オブジェクト（Value Object）

**定義**: 同一性を持たず、値そのものが意味を持つオブジェクト。

- 変更不可（immutable）であることが多い
- 等価性は「値が同じか」で決まる

**このアプリの例**:
- `JobType`（実行秒数）
- `JobResult`（結果メッセージ/エラー）
- `NotificationChannel`（通知チャネル）

## 集約（Aggregate）と集約ルート

**定義**: 複数のオブジェクトを 1 つの整合性境界としてまとめたもの。

- 外部から直接触れるのは **集約ルート** のみ
- ルール（不変条件）を守るための“門番”

**このアプリの例**:
- `Job` が集約ルート
- 状態遷移は `Job.start()` / `complete()` / `fail()` / `cancel()` だけで行う

### 集約境界の考え方

- 集約は **整合性を守る最小単位**\n- 集約の外から内部を直接触れない\n- 変更の責務は集約ルートに集約する

## 不変条件（Invariants）

**定義**: どんな時でも守られるべきルール。

このアプリの代表例:
- `COMPLETED` のジョブは `CANCELLED` に遷移できない
- `PENDING` から `FAILED` には直接遷移できない

実装箇所:
- `JobStatus.transition_to` で許可されない遷移を例外にする
- `InvalidStatusTransitionError` によって不正操作を防ぐ

## ドメインイベント（Domain Event）

**定義**: ドメイン内で起きた重要な出来事を表すイベント。

- 「起きた事実」を表現する
- 他のコンポーネントへ情報を届ける手段

**このアプリの例**:
- `JobCreated`, `JobStarted`, `JobCompleted`, `JobFailed`, `JobCancelled`
- 発行場所: `Job` のメソッド内
- 配信場所: `RedisEventPublisher` が Redis へ配信

イベントは SSE/ワーカーの起点になり、UI 更新やジョブ実行につながります。

### イベントの意義

- **「起きた事実」を記録する**（過去の変更は取り消せない）\n- **別の処理を疎結合に起動できる**（UI/通知/ワーカー）

## リポジトリ（Repository）

**定義**: 集約の永続化を扱う抽象的な “置き場”。

- ドメインは DB に依存しない
- リポジトリはポート（抽象）として定義される

**このアプリの例**:
- ポート: `JobRepository`（`backend/src/app/ports/repository.py`）
- 実装: `PostgresJobRepository`

### リポジトリと集約の分離

- 集約は DB を知らない\n- リポジトリが **DB と集約の変換** を担当する

## 概念間の関係（図）

```mermaid
flowchart TB
  subgraph Domain["ドメイン"]
    A[Aggregate Root: Job]
    VO[Value Objects]
    EV[Domain Events]
  end

  UC[UseCase]
  REP[Repository (Port)]
  DB[(DB Adapter)]

  UC --> A
  A --> EV
  UC --> REP
  REP --> DB
  A --> VO
```

## ドメイン層のまとめ

DDD 的に見ると、ドメイン層は「外部事情から独立したルール集」です。

- DB, Redis, HTTP に依存しない
- “守るべきルール” を中心に設計されている

この「ドメインの独立性」を維持することが、長期的な変更耐性につながります。

次章では、このドメインを支える **ヘキサゴナルアーキテクチャ** を厚めに解説します。

## 要点サマリ

- DDD は「ルールを中心に置く」ための設計\n- 集約は整合性を守る単位で、外部から直接触れない\n- ドメインイベントは“起きた事実”を伝える\n- リポジトリは DB と集約を分離する

## ここまで読んだら

ヘキサゴナル章（`03_hexagonal.md`）を読み、  
次に `04_app_structure.md` で実装との対応を確認してください。
